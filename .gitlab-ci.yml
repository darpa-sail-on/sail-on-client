image: pytorch/pytorch:1.7.1-cuda11.0-cudnn8-devel

.setup: &setup
  - apt update
  - apt-get install -y git build-essential software-properties-common
  - apt-add-repository -y ppa:deadsnakes/ppa
  - apt update
  - apt install -y python3.7 python3-pip
  - python3.7 -m pip install pipenv
  - cd ..
  - git clone https://${SAIL_ON_API_UNAME}:${SAIL_ON_API_TOKEN}@gitlab.kitware.com/darpa-sail-on/sail-on-api
  - git clone https://${TINKER_ENGINE_DEPRECATED_UNAME}:${TINKER_ENGINE_DEPRECATED_TOKEN}@gitlab.kitware.com/darpa-sail-on/sailon_tinker_launcher
  - git clone https://${EVM_BASED_ND_UNAME}:${EVM_BASED_ND_TOKEN}@gitlab.kitware.com/darpa-sail-on/evm_based_novelty_detector
  - git clone https://${TINKER_ENGINE_UNAME}:${TINKER_ENGINE_TOKEN}@gitlab.kitware.com/darpa_learn/tinker-engine
  - git clone https://${GRAPH_AUTOENCODER_UNAME}:${GRAPH_AUTOENCODER_TOKEN}@gitlab.kitware.com/darpa-sail-on/graph-autoencoder
  - git clone https://${HWR_UNAME}:${HWR_TOKEN}@gitlab.kitware.com/darpa-sail-on/hwr_novelty_detector
  - cd sail-on-client
  - pipenv --python=$(which python3.7) install -d

lint:
  tags:
    - linux
    - docker
    - build
  script:
    - *setup
    - pipenn --python=$(which python3.7) run lint

test-with-coverage:
  tags:
    - linux
    - docker
    - build
  script:
    - *setup
    - pipenv --python=$(which python3.7) run test-with-coverage
    - pipenv --python=$(which python3.7) run coverage-report

typecheck:
  tags:
    - linux
    - docker
    - build
  script:
    - *setup
    - pipenv --python=$(which python3.7) run typecheck

pages:
  tags:
    - linux
    - docker
    - build
  script:
    - *setup
    - pipenv --python=$(which python3.7) run docs
    - mv docs/build/html public/
  artifacts:
    paths:
      - public
  only:
    - master
